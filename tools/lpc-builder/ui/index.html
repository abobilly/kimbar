<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPC Character Builder</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --surface-2: #0f3460;
            --accent: #e94560;
            --text: #eaeaea;
            --text-dim: #888;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 340px;
            background: var(--surface);
            padding: 20px;
            overflow-y: auto;
            max-height: 100vh;
            border-right: 1px solid var(--surface-2);
        }

        .sidebar h1 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--accent);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select {
            width: 100%;
            padding: 8px 10px;
            background: var(--surface-2);
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .color-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .swatch {
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.1s;
        }

        .swatch:hover {
            transform: scale(1.15);
        }

        .swatch.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--bg);
        }

        .preview-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            background: repeating-conic-gradient(#222 0% 25%, #2a2a2a 0% 50%) 50% / 20px 20px;
        }

        .preview-container {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        #preview-frame {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            width: 256px;
            height: 256px;
            background: transparent;
        }

        .anim-controls {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }

        .anim-btn {
            padding: 6px 14px;
            background: var(--surface-2);
            border: none;
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .anim-btn:hover {
            background: #1a4980;
        }

        .anim-btn.active {
            background: var(--accent);
        }

        .direction-controls {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            justify-content: center;
        }

        .dir-btn {
            width: 32px;
            height: 32px;
            background: var(--surface-2);
            border: none;
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.8rem;
        }

        .dir-btn:hover {
            background: #1a4980;
        }

        .dir-btn.active {
            background: var(--accent);
        }

        .export-section {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--surface-2);
        }

        .btn-primary {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            width: 100%;
            padding: 8px;
            background: var(--surface-2);
            border: none;
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 6px;
        }

        .btn-secondary:hover {
            background: #1a4980;
        }

        .config-output {
            background: #0a0a15;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            text-align: left;
        }

        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 12px;
        }

        .tab-btn {
            padding: 5px 10px;
            background: var(--surface-2);
            border: none;
            border-radius: 3px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .loading {
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h1>LPC Character Builder</h1>

        <div class="category-tabs">
            <button class="tab-btn active" data-tab="body">Body</button>
            <button class="tab-btn" data-tab="face">Face</button>
            <button class="tab-btn" data-tab="hair">Hair</button>
            <button class="tab-btn" data-tab="clothes">Clothes</button>
            <button class="tab-btn" data-tab="accessories">Extras</button>
        </div>

        <!-- Body tab -->
        <div class="category-content active" id="tab-body">
            <div class="control-group">
                <label>Body Type</label>
                <select id="body-type">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="muscular">Muscular</option>
                    <option value="teen">Teen</option>
                    <option value="child">Child</option>
                </select>
            </div>

            <div class="control-group">
                <label>Skin Color</label>
                <div class="color-swatches" id="skin-colors"></div>
            </div>
        </div>

        <!-- Face tab -->
        <div class="category-content" id="tab-face">
            <div class="control-group">
                <label>Eye Color</label>
                <div class="color-swatches" id="eye-colors"></div>
            </div>
        </div>

        <!-- Hair tab -->
        <div class="category-content" id="tab-hair">
            <div class="control-group">
                <label>Hair Style</label>
                <select id="hair-style">
                    <option value="">Bald</option>
                </select>
            </div>

            <div class="control-group">
                <label>Hair Color</label>
                <div class="color-swatches" id="hair-colors"></div>
            </div>

            <div class="control-group">
                <label>Facial Hair</label>
                <select id="beard-style">
                    <option value="">None</option>
                </select>
            </div>
        </div>

        <!-- Clothes tab -->
        <div class="category-content" id="tab-clothes">
            <div class="control-group">
                <label>Shirt/Top</label>
                <select id="torso"></select>
            </div>

            <div class="control-group">
                <label>Top Color</label>
                <select id="torso-color"></select>
            </div>

            <div class="control-group">
                <label>Pants/Bottom</label>
                <select id="legs"></select>
            </div>

            <div class="control-group">
                <label>Bottom Color</label>
                <select id="legs-color"></select>
            </div>

            <div class="control-group">
                <label>Footwear</label>
                <select id="feet"></select>
            </div>

            <div class="control-group">
                <label>Footwear Color</label>
                <select id="feet-color"></select>
            </div>
        </div>

        <!-- Accessories tab -->
        <div class="category-content" id="tab-accessories">
            <div class="control-group">
                <label>Headwear</label>
                <select id="head">
                    <option value="">None</option>
                </select>
            </div>

            <div class="control-group">
                <label>Belt</label>
                <select id="belt">
                    <option value="">None</option>
                </select>
            </div>

            <div class="control-group">
                <label>Cape</label>
                <select id="cape">
                    <option value="">None</option>
                </select>
            </div>
        </div>

        <!-- Export section -->
        <div class="export-section">
            <button class="btn-primary" onclick="downloadSpritesheet()">Download Spritesheet</button>
            <button class="btn-secondary" onclick="randomize()">Randomize</button>
            <button class="btn-secondary" onclick="copyConfig()">Copy Config JSON</button>
            <div class="config-output" id="config-output">{}</div>
        </div>
    </div>

    <div class="preview-area">
        <div class="preview-container">
            <img id="preview-frame" alt="Character Preview">

            <div class="anim-controls">
                <button class="anim-btn active" data-anim="walk">Walk</button>
                <button class="anim-btn" data-anim="cast">Cast</button>
                <button class="anim-btn" data-anim="slash">Slash</button>
                <button class="anim-btn" data-anim="thrust">Thrust</button>
            </div>

            <div class="direction-controls">
                <button class="dir-btn" data-dir="up">U</button>
                <button class="dir-btn" data-dir="left">L</button>
                <button class="dir-btn active" data-dir="down">D</button>
                <button class="dir-btn" data-dir="right">R</button>
            </div>
        </div>
    </div>

    <script>
        // Character config state
        let config = {
            body_type: 'male',
            skin_color: 'light',
            eye_color: 'blue',
            hair_style: '',
            hair_color: 'brown',
        };

        // Animation state
        let currentAnim = 'walk';
        let currentDir = 'down';
        let currentFrame = 0;
        let animationTimer = null;

        // LPC animation layout (row offsets for each direction)
        // Rows are: up=0, left=1, down=2, right=3 for each animation block
        const ANIMS = {
            cast: { baseRow: 0, frames: 7 },
            thrust: { baseRow: 4, frames: 8 },
            walk: { baseRow: 8, frames: 9 },
            slash: { baseRow: 12, frames: 6 },
            shoot: { baseRow: 16, frames: 13 },
            hurt: { baseRow: 20, frames: 6 },
        };

        const DIR_OFFSETS = {
            up: 0,
            left: 1,
            down: 2,
            right: 3,
        };

        // Loaded options from server
        let serverOptions = null;

        // Approximate skin color hex (for swatches)
        const SKIN_HEX = {
            light: '#f5d6c6', tanned: '#e8c5a0', olive: '#c9a86c', taupe: '#b39477',
            bronze: '#c6946b', brown: '#8d5524', black: '#4a312c', amber: '#ffcc99',
            lavender: '#c4a4d4', blue: '#6488aa', green: '#7eb060', zombie_green: '#86a17d',
            peach: '#ffdab9', dark: '#5c3d2e', pale: '#ffe8d6',
        };

        // Hair color hex
        const HAIR_HEX = {
            black: '#1a1a1a', brown: '#4a3728', brunette: '#6b4423', auburn: '#8b4513',
            red: '#b74040', ginger: '#c77040', blonde: '#d4a44a', platinum: '#e8e0c8',
            white: '#f0f0f0', grey: '#808080', blue: '#4080c0', green: '#408040',
            purple: '#804080', pink: '#c040a0', ash: '#9a8478', strawberry: '#c97451',
            gold: '#daa520', silver: '#c0c0c0', copper: '#b87333',
        };

        // Eye color hex
        const EYE_HEX = {
            blue: '#4488cc', green: '#44aa66', brown: '#8b4513', grey: '#888888',
            amber: '#cc8844', red: '#cc4444', purple: '#884488', yellow: '#cccc44',
            orange: '#cc7744', black: '#222222', aqua: '#00cccc', violet: '#8844cc',
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initTabs();
            initDirectionButtons();
            await loadOptions();
            updatePreview();
            startAnimation();
        });

        async function loadOptions() {
            try {
                const response = await fetch('options.json');
                serverOptions = await response.json();
                populateControls();
            } catch (e) {
                console.error('Could not load options.json:', e);
            }
        }

        function populateControls() {
            if (!serverOptions) return;

            // Skin colors
            const skinContainer = document.getElementById('skin-colors');
            skinContainer.innerHTML = '';
            const skinColors = serverOptions.body?.skin_colors || [];
            skinColors.forEach(color => {
                const hex = SKIN_HEX[color] || '#888';
                skinContainer.appendChild(createSwatch(color, hex, 'skin_color'));
            });

            // Eye colors
            const eyeContainer = document.getElementById('eye-colors');
            eyeContainer.innerHTML = '';
            const eyeColors = serverOptions.eyes?.colors || [];
            eyeColors.forEach(color => {
                const hex = EYE_HEX[color] || '#888';
                eyeContainer.appendChild(createSwatch(color, hex, 'eye_color'));
            });

            // Hair styles
            const hairSelect = document.getElementById('hair-style');
            hairSelect.innerHTML = '<option value="">Bald</option>';
            const hairStyles = Object.keys(serverOptions.hair || {}).sort();
            hairStyles.forEach(style => {
                const opt = document.createElement('option');
                opt.value = style;
                opt.textContent = style.replace(/_/g, ' ');
                hairSelect.appendChild(opt);
            });
            hairSelect.addEventListener('change', onControlChange);

            // Hair colors (aggregate from all styles)
            const hairContainer = document.getElementById('hair-colors');
            hairContainer.innerHTML = '';
            const allHairColors = new Set();
            Object.values(serverOptions.hair || {}).forEach(colors => {
                colors.forEach(c => allHairColors.add(c));
            });
            Array.from(allHairColors).sort().forEach(color => {
                const hex = HAIR_HEX[color] || '#888';
                hairContainer.appendChild(createSwatch(color, hex, 'hair_color'));
            });

            // Beard styles
            const beardSelect = document.getElementById('beard-style');
            beardSelect.innerHTML = '<option value="">None</option>';
            const beardStyles = Object.keys(serverOptions.beard || {}).sort();
            beardStyles.forEach(style => {
                const opt = document.createElement('option');
                opt.value = style;
                opt.textContent = style.replace(/_/g, ' ');
                beardSelect.appendChild(opt);
            });
            beardSelect.addEventListener('change', onControlChange);

            // Torso clothing
            populateClothingSelect('torso', serverOptions.clothing?.torso || {});
            populateColorSelect('torso-color', serverOptions.clothing?.torso || {});

            // Legs
            populateClothingSelect('legs', serverOptions.clothing?.legs || {});
            populateColorSelect('legs-color', serverOptions.clothing?.legs || {});

            // Feet
            populateClothingSelect('feet', serverOptions.clothing?.feet || {});
            populateColorSelect('feet-color', serverOptions.clothing?.feet || {});

            // Head accessories
            populateAccessorySelect('head', serverOptions.accessories?.head || {});

            // Belt
            populateAccessorySelect('belt', serverOptions.accessories?.belt || {});

            // Cape
            populateAccessorySelect('cape', serverOptions.accessories?.cape || {});

            // Body type
            document.getElementById('body-type').addEventListener('change', onControlChange);
        }

        function populateClothingSelect(id, items) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">None</option>';
            Object.keys(items).sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item.replace(/^(torso_|legs_|feet_)/, '').replace(/_/g, ' ');
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                config[id] = e.target.value;
                // Update color options for this item
                updateColorOptions(id + '-color', items[e.target.value] || []);
                updatePreview();
            });
        }

        function populateColorSelect(id, items) {
            const select = document.getElementById(id);
            select.innerHTML = '';
            // Aggregate all colors
            const allColors = new Set();
            Object.values(items).forEach(colors => {
                colors.forEach(c => allColors.add(c));
            });
            Array.from(allColors).sort().forEach(color => {
                const opt = document.createElement('option');
                opt.value = color;
                opt.textContent = color.replace(/_/g, ' ');
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                config[id.replace('-', '_')] = e.target.value;
                updatePreview();
            });
        }

        function updateColorOptions(selectId, colors) {
            const select = document.getElementById(selectId);
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '';
            (colors.length ? colors : ['white', 'black', 'brown', 'grey']).forEach(color => {
                const opt = document.createElement('option');
                opt.value = color;
                opt.textContent = color.replace(/_/g, ' ');
                select.appendChild(opt);
            });
            if (colors.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function populateAccessorySelect(id, items) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">None</option>';
            Object.keys(items).sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item.replace(/^(head_|belt_|cape_)/, '').replace(/_/g, ' ');
                select.appendChild(opt);
            });
            select.addEventListener('change', (e) => {
                config[id] = e.target.value;
                updatePreview();
            });
        }

        function createSwatch(name, hex, configKey) {
            const swatch = document.createElement('div');
            swatch.className = 'swatch';
            swatch.style.backgroundColor = hex;
            swatch.title = name;
            swatch.dataset.value = name;
            swatch.dataset.key = configKey;

            if (config[configKey] === name) {
                swatch.classList.add('selected');
            }

            swatch.addEventListener('click', () => {
                swatch.parentElement.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected');
                config[configKey] = name;
                updatePreview();
            });

            return swatch;
        }

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.category-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
                });
            });

            // Animation buttons
            document.querySelectorAll('.anim-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.anim-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentAnim = btn.dataset.anim;
                    currentFrame = 0;
                });
            });
        }

        function initDirectionButtons() {
            document.querySelectorAll('.dir-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentDir = btn.dataset.dir;
                    currentFrame = 0;
                });
            });
        }

        function onControlChange(e) {
            const key = e.target.id.replace(/-/g, '_');
            config[key] = e.target.value;
            updatePreview();
        }

        function updatePreview() {
            // Update config display
            document.getElementById('config-output').textContent = JSON.stringify(config, null, 2);

            // Request frame from server
            fetchFrame();
        }

        let fetchPending = false;
        let fetchQueued = false;

        async function fetchFrame() {
            if (fetchPending) {
                fetchQueued = true;
                return;
            }

            fetchPending = true;
            const anim = ANIMS[currentAnim] || ANIMS.walk;
            const row = anim.baseRow + DIR_OFFSETS[currentDir];
            const col = currentFrame % anim.frames;

            try {
                const url = `/api/frame?config=${encodeURIComponent(JSON.stringify(config))}&row=${row}&col=${col}&scale=4`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.image) {
                    document.getElementById('preview-frame').src = data.image;
                }
            } catch (e) {
                console.error('Failed to fetch frame:', e);
            }

            fetchPending = false;
            if (fetchQueued) {
                fetchQueued = false;
                fetchFrame();
            }
        }

        function startAnimation() {
            function tick() {
                const anim = ANIMS[currentAnim] || ANIMS.walk;
                currentFrame = (currentFrame + 1) % anim.frames;
                fetchFrame();
            }

            animationTimer = setInterval(tick, 120);
        }

        async function randomize() {
            try {
                // Fetch a random config from the server
                const response = await fetch('/api/frame?config=' + encodeURIComponent(JSON.stringify({
                    body_type: randomChoice(['male', 'female', 'muscular']),
                    skin_color: randomChoice(serverOptions?.body?.skin_colors || ['light']),
                    eye_color: randomChoice(serverOptions?.eyes?.colors || ['blue']),
                    hair_style: randomChoice(['', ...Object.keys(serverOptions?.hair || {})]),
                    hair_color: randomChoice(Object.keys(HAIR_HEX)),
                })) + '&row=10&col=0&scale=4');

                // Build random config locally
                config = {
                    body_type: randomChoice(['male', 'female', 'muscular']),
                    skin_color: randomChoice(serverOptions?.body?.skin_colors || ['light']),
                    eye_color: randomChoice(serverOptions?.eyes?.colors || ['blue']),
                    hair_style: randomChoice(['', ...Object.keys(serverOptions?.hair || {})]),
                    hair_color: randomChoice(Object.keys(HAIR_HEX)),
                };

                // Maybe add clothing
                if (Math.random() > 0.3) {
                    const torsoItems = Object.keys(serverOptions?.clothing?.torso || {});
                    if (torsoItems.length) {
                        config.torso = randomChoice(torsoItems);
                        const colors = serverOptions.clothing.torso[config.torso] || ['white'];
                        config.torso_color = randomChoice(colors);
                    }
                }

                if (Math.random() > 0.3) {
                    const legsItems = Object.keys(serverOptions?.clothing?.legs || {});
                    if (legsItems.length) {
                        config.legs = randomChoice(legsItems);
                        const colors = serverOptions.clothing.legs[config.legs] || ['white'];
                        config.legs_color = randomChoice(colors);
                    }
                }

                // Update UI
                document.getElementById('body-type').value = config.body_type;
                document.getElementById('hair-style').value = config.hair_style || '';
                document.getElementById('beard-style').value = config.beard_style || '';
                document.getElementById('torso').value = config.torso || '';
                document.getElementById('legs').value = config.legs || '';

                updateSwatchSelection('skin-colors', config.skin_color);
                updateSwatchSelection('eye-colors', config.eye_color);
                updateSwatchSelection('hair-colors', config.hair_color);

                updatePreview();
            } catch (e) {
                console.error('Randomize failed:', e);
            }
        }

        function randomChoice(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function updateSwatchSelection(containerId, value) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.querySelectorAll('.swatch').forEach(s => {
                s.classList.toggle('selected', s.dataset.value === value);
            });
        }

        async function downloadSpritesheet() {
            const url = `/api/composite?config=${encodeURIComponent(JSON.stringify(config))}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = 'character.png';
            a.click();
        }

        function copyConfig() {
            navigator.clipboard.writeText(JSON.stringify(config, null, 2))
                .then(() => alert('Config copied to clipboard'));
        }
    </script>
</body>

</html>