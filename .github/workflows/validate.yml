name: Validate

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    validate:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium

            - name: Run full check (mirrors npm run check)
              run: |
                  echo "=== Content Pipeline ==="
                  npm run prepare:content

                  echo "=== Verify Invariants ==="
                  npm run verify

                  echo "=== Check Boundaries ==="
                  npm run check-boundaries

                  echo "=== Unit Tests ==="
                  npm run test:unit

                  echo "=== E2E Tests ==="
                  npm run test:e2e

                  echo "=== Build ==="
                  npm run build-nolog

            - name: Upload test results
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: test-results
                  path: |
                      test-results/
                      playwright-report/
                  retention-days: 7

    # Fast check for draft PRs
    validate-fast:
        if: github.event.pull_request.draft == true
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run fast check (mirrors npm run check:fast)
              run: |
                  npm run prepare:content
                  npm run verify
                  npm run check-boundaries
                  npm run test:unit
                  npm run build-nolog
